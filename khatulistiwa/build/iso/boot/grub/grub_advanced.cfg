# ============================================================================
# grub_advanced.cfg - Advanced GRUB Configuration untuk Khatulistiwa OS
# Copyright (c) 2025 Dhafa Nazula Permadi & Team BIGCode By Cv Bintang Gumilang Group
# ============================================================================
# 
# Advanced GRUB configuration dengan fitur:
# 1. Multi-platform boot support
# 2. Cultural themes dan backgrounds
# 3. Advanced boot options
# 4. Hardware detection
# 5. Multi-language support
# 6. Cultural boot animations

# GRUB configuration
set timeout=15
set default=0
set timeout_style=menu

# Load cultural theme
set theme=/boot/grub/themes/khatulistiwa/theme.txt

# Set background image
if background_image /boot/grub/themes/khatulistiwa/background.png; then
    set color_normal=white/black
    set color_highlight=yellow/red
else
    set menu_color_normal=white/red
    set menu_color_highlight=yellow/red
fi

# Load fonts for Indonesian characters
if loadfont /boot/grub/themes/khatulistiwa/fonts/unicode.pf2; then
    set gfxmode=auto
    insmod gfxterm
    insmod png
    terminal_output gfxterm
fi

# Cultural welcome messages
echo "╔══════════════════════════════════════════════════════════╗"
echo "║                KHATULISTIWA OS BOOTLOADER                ║"
echo "║            Sistem Operasi Indonesia                     ║"
echo "║        'Teknologi Modern, Jiwa Indonesia'               ║"
echo "╚══════════════════════════════════════════════════════════╝"
echo ""
echo "Selamat datang di Khatulistiwa OS - Welcome to Khatulistiwa OS"
echo "Bhinneka Tunggal Ika - Unity in Diversity"
echo ""

# Detect hardware platform
if cpuid -l; then
    set platform="x86_64"
else
    set platform="x86"
fi

# Main menu entries

# ============================================================================
# NORMAL BOOT OPTIONS
# ============================================================================

menuentry "🇮🇩 Khatulistiwa OS - Normal Boot" --class khatulistiwa --class os {
    echo "════════════════════════════════════════════════════════════"
    echo "Memuat Khatulistiwa OS - Loading Khatulistiwa OS"
    echo "Platform: $platform"
    echo "Mode: Normal dengan budaya Indonesia"
    echo "════════════════════════════════════════════════════════════"
    
    # Set kernel parameters
    set kernel_params="root=UUID=khatulistiwa-root ro quiet splash"
    set cultural_params="cultural_mode=on batik_theme=parang gamelan=on wayang=on garuda=on"
    set platform_params="platform=$platform"
    
    # Load kernel
    linux /boot/khatkernel $kernel_params $cultural_params $platform_params
    
    # Load initrd
    initrd /boot/khat-initrd.img
}

menuentry "🎨 Khatulistiwa OS - Cultural Full Mode (Mode Budaya Penuh)" --class cultural --class os {
    echo "════════════════════════════════════════════════════════════"
    echo "Memuat Mode Budaya Penuh - Loading Full Cultural Mode"
    echo "Fitur: Semua elemen budaya Indonesia aktif"
    echo "Features: All Indonesian cultural elements active"
    echo "════════════════════════════════════════════════════════════"
    
    set kernel_params="root=UUID=khatulistiwa-root ro quiet splash"
    set cultural_params="cultural_mode=full batik_theme=sekar_jagad gamelan=full wayang=full garuda=animated"
    set audio_params="gamelan_ensemble=complete traditional_sounds=on"
    set graphics_params="wayang_animations=full batik_live=on cultural_ui=enhanced"
    
    linux /boot/khatkernel $kernel_params $cultural_params $audio_params $graphics_params
    initrd /boot/khat-initrd-cultural.img
}

# ============================================================================
# SAFE AND RECOVERY OPTIONS
# ============================================================================

menuentry "🛡️ Khatulistiwa OS - Safe Mode (Mode Aman)" --class safe --class os {
    echo "════════════════════════════════════════════════════════════"
    echo "Memuat Mode Aman - Loading Safe Mode"
    echo "Mode: Minimal dengan driver dasar"
    echo "Mode: Minimal with basic drivers"
    echo "════════════════════════════════════════════════════════════"
    
    set kernel_params="root=UUID=khatulistiwa-root ro single nomodeset"
    set safe_params="cultural_mode=minimal safe_mode=on debug=on"
    
    linux /boot/khatkernel $kernel_params $safe_params
    initrd /boot/khat-initrd-safe.img
}

menuentry "🔧 Khatulistiwa OS - Recovery Mode (Mode Pemulihan)" --class recovery --class os {
    echo "════════════════════════════════════════════════════════════"
    echo "Memuat Mode Pemulihan - Loading Recovery Mode"
    echo "Mode: Pemulihan sistem dan perbaikan"
    echo "Mode: System recovery and repair"
    echo "════════════════════════════════════════════════════════════"
    
    set kernel_params="root=UUID=khatulistiwa-root ro recovery"
    set recovery_params="cultural_mode=off recovery=on emergency=on"
    
    linux /boot/khatkernel $kernel_params $recovery_params
    initrd /boot/khat-initrd-recovery.img
}

# ============================================================================
# ADVANCED BOOT OPTIONS
# ============================================================================

submenu "⚙️ Advanced Boot Options (Opsi Boot Lanjutan)" --class advanced {
    
    menuentry "🖥️ Khatulistiwa OS - Debug Mode" --class debug {
        echo "Memuat dengan debug lengkap - Loading with full debugging"
        
        set kernel_params="root=UUID=khatulistiwa-root ro"
        set debug_params="debug loglevel=7 cultural_debug=on kernel_debug=on"
        set verbose_params="verbose splash=off quiet=off"
        
        linux /boot/khatkernel $kernel_params $debug_params $verbose_params
        initrd /boot/khat-initrd.img
    }
    
    menuentry "🌐 Khatulistiwa OS - Network Boot" --class network {
        echo "Memuat dari jaringan - Loading from network"
        
        set kernel_params="root=UUID=khatulistiwa-root ro"
        set network_params="netboot=on cultural_mode=on ip=dhcp"
        
        linux /boot/khatkernel $kernel_params $network_params
        initrd /boot/khat-initrd-network.img
    }
    
    menuentry "💾 Khatulistiwa OS - Minimal Mode" --class minimal {
        echo "Mode minimal tanpa GUI - Minimal mode without GUI"
        
        set kernel_params="root=UUID=khatulistiwa-root ro"
        set minimal_params="text cultural_mode=text_only systemd.unit=multi-user.target"
        
        linux /boot/khatkernel $kernel_params $minimal_params
        initrd /boot/khat-initrd-minimal.img
    }
}

# ============================================================================
# CULTURAL THEME OPTIONS
# ============================================================================

submenu "🎨 Cultural Themes (Tema Budaya)" --class themes {
    
    menuentry "🌺 Tema Parang - Kekuatan dan Keteguhan" --class parang {
        echo "Tema Batik Parang - Melambangkan kekuatan"
        
        set cultural_params="batik_theme=parang cultural_colors=traditional"
        linux /boot/khatkernel root=UUID=khatulistiwa-root ro quiet splash cultural_mode=on $cultural_params
        initrd /boot/khat-initrd.img
    }
    
    menuentry "🕸️ Tema Kawung - Kesucian dan Kebijaksanaan" --class kawung {
        echo "Tema Batik Kawung - Melambangkan kesucian"
        
        set cultural_params="batik_theme=kawung cultural_colors=sacred"
        linux /boot/khatkernel root=UUID=khatulistiwa-root ro quiet splash cultural_mode=on $cultural_params
        initrd /boot/khat-initrd.img
    }
    
    menuentry "☁️ Tema Mega Mendung - Ketenangan dan Kesabaran" --class mega_mendung {
        echo "Tema Batik Mega Mendung - Melambangkan ketenangan"
        
        set cultural_params="batik_theme=mega_mendung cultural_colors=calm"
        linux /boot/khatkernel root=UUID=khatulistiwa-root ro quiet splash cultural_mode=on $cultural_params
        initrd /boot/khat-initrd.img
    }
    
    menuentry "🌸 Tema Sekar Jagad - Keindahan Dunia" --class sekar_jagad {
        echo "Tema Batik Sekar Jagad - Melambangkan keindahan dunia"
        
        set cultural_params="batik_theme=sekar_jagad cultural_colors=vibrant"
        linux /boot/khatkernel root=UUID=khatulistiwa-root ro quiet splash cultural_mode=full $cultural_params
        initrd /boot/khat-initrd-cultural.img
    }
}

# ============================================================================
# PLATFORM-SPECIFIC OPTIONS
# ============================================================================

if [ "$platform" = "x86_64" ]; then
    submenu "🖥️ x86_64 Specific Options" --class x86_64 {
        menuentry "UEFI Boot dengan Secure Boot" {
            echo "Boot UEFI dengan verifikasi keamanan"
            set kernel_params="root=UUID=khatulistiwa-root ro quiet splash"
            set security_params="secure_boot=on cultural_signature_check=on"
            linux /boot/khatkernel $kernel_params $security_params
            initrd /boot/khat-initrd.img
        }
        
        menuentry "Legacy BIOS Compatibility" {
            echo "Mode kompatibilitas BIOS lama"
            set kernel_params="root=UUID=khatulistiwa-root ro"
            set legacy_params="legacy_mode=on cultural_mode=compatible"
            linux /boot/khatkernel $kernel_params $legacy_params
            initrd /boot/khat-initrd.img
        }
    }
fi

# ============================================================================
# SYSTEM UTILITIES
# ============================================================================

submenu "🛠️ System Utilities (Utilitas Sistem)" --class utilities {
    
    menuentry "🧠 Memory Test (Tes Memori)" --class memtest {
        echo "Memulai tes memori sistem..."
        echo "Starting system memory test..."
        linux16 /boot/memtest86+.bin
    }
    
    menuentry "💽 Disk Check (Pemeriksaan Disk)" --class diskcheck {
        echo "Memeriksa integritas disk..."
        echo "Checking disk integrity..."
        linux /boot/khatkernel root=UUID=khatulistiwa-root ro fsck.mode=force
        initrd /boot/khat-initrd-fsck.img
    }
    
    menuentry "🔍 Hardware Detection (Deteksi Perangkat Keras)" --class hwdetect {
        echo "Mendeteksi perangkat keras..."
        echo "Detecting hardware..."
        linux /boot/khatkernel root=UUID=khatulistiwa-root ro hardware_detect=verbose
        initrd /boot/khat-initrd-hwdetect.img
    }
    
    menuentry "🎵 Audio Test (Tes Audio Gamelan)" --class audiotest {
        echo "Tes sistem audio gamelan..."
        echo "Testing gamelan audio system..."
        linux /boot/khatkernel root=UUID=khatulistiwa-root ro audio_test=gamelan cultural_mode=audio_only
        initrd /boot/khat-initrd.img
    }
}

# ============================================================================
# OTHER OPERATING SYSTEMS
# ============================================================================

# Detect other operating systems
if [ -f /boot/grub/custom.cfg ]; then
    source /boot/grub/custom.cfg
fi

# Windows detection
if [ -f (hd0,1)/bootmgr ]; then
    menuentry "🪟 Windows" --class windows --class os {
        echo "Memuat Windows..."
        echo "Loading Windows..."
        insmod part_msdos
        insmod ntfs
        set root='hd0,msdos1'
        chainloader +1
    }
fi

# Linux detection
if [ -f (hd0,2)/vmlinuz ]; then
    menuentry "🐧 Linux (Other)" --class linux --class os {
        echo "Memuat Linux lainnya..."
        echo "Loading other Linux..."
        set root='hd0,msdos2'
        linux /vmlinuz root=/dev/sda2 ro
        initrd /initrd.img
    }
fi

# ============================================================================
# GRUB UTILITIES
# ============================================================================

menuentry "⚙️ GRUB Command Line" --class commandline {
    echo "Membuka command line GRUB..."
    echo "Opening GRUB command line..."
    terminal_output console
    terminal_input console
}

menuentry "🔄 Reboot (Restart)" --class reboot {
    echo "Merestart sistem..."
    echo "Restarting system..."
    reboot
}

menuentry "⏻ Shutdown (Matikan)" --class shutdown {
    echo "Mematikan sistem..."
    echo "Shutting down system..."
    halt
}
